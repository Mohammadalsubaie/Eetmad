name: Develop Branch CI/CD

on:
    pull_request:
        branches:
            - develop
    push:
        branches:
            - develop

# Cancel in-progress runs when a new one starts
concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

env:
    NODE_VERSION: '20'
    WORKING_DIR: frontend/eetmad

jobs:
    # ========================================================================
    # JOB 1: Setup & Cache Dependencies
    # Purpose: Install dependencies once and cache for all jobs
    # Duration: ~30-60 seconds (first run), ~5 seconds (cached)
    # ========================================================================
    setup:
        name: ðŸš€ Setup & Cache Dependencies
        runs-on: ubuntu-latest

        outputs:
            cache-hit: ${{ steps.cache-node-modules.outputs.cache-hit }}

        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            # Cache node_modules for faster subsequent runs
            - name: ðŸ’¾ Cache node_modules
              id: cache-node-modules
              uses: actions/cache@v4
              with:
                  path: ${{ env.WORKING_DIR }}/node_modules
                  key: ${{ runner.os }}-node-modules-${{ hashFiles('frontend/eetmad/package-lock.json') }}
                  restore-keys: |
                      ${{ runner.os }}-node-modules-

            - name: ðŸ“¥ Install dependencies
              if: steps.cache-node-modules.outputs.cache-hit != 'true'
              working-directory: ${{ env.WORKING_DIR }}
              run: npm ci --prefer-offline --no-audit

            - name: âœ… Dependencies ready
              run: echo "Dependencies installed and cached successfully"

    # ========================================================================
    # JOB 2: Quick Checks (Fast fail-fast checks)
    # Purpose: Fast validation to catch common errors early
    # Duration: ~20-40 seconds
    # ========================================================================
    quick-checks:
        name: âš¡ Quick Validation
        runs-on: ubuntu-latest
        needs: setup

        defaults:
            run:
                working-directory: ${{ env.WORKING_DIR }}

        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: ðŸ’¾ Restore node_modules cache
              uses: actions/cache@v4
              with:
                  path: ${{ env.WORKING_DIR }}/node_modules
                  key: ${{ runner.os }}-node-modules-${{ hashFiles('frontend/eetmad/package-lock.json') }}

            - name: ðŸ” ESLint Check
              run: |
                  # Run ESLint and capture output
                  LINT_OUTPUT=$(npm run lint:check 2>&1 || true)
                  LINT_EXIT_CODE=$?
                  
                  # Check output for errors vs warnings
                  ERROR_COUNT=$(echo "$LINT_OUTPUT" | grep -oE "[0-9]+ error" | grep -oE "[0-9]+" || echo "0")
                  WARNING_COUNT=$(echo "$LINT_OUTPUT" | grep -oE "[0-9]+ warning" | grep -oE "[0-9]+" || echo "0")
                  
                  # Display full output
                  echo "$LINT_OUTPUT"
                  
                  # Fail only if there are actual errors
                  if [ "$ERROR_COUNT" -gt 0 ]; then
                      echo "::error::ESLint found $ERROR_COUNT error(s). Please fix them."
                      exit 1
                  elif [ "$WARNING_COUNT" -gt 0 ]; then
                      echo "::warning::ESLint found $WARNING_COUNT warning(s). Consider fixing them."
                      echo "Run 'npm run lint -- --fix' to auto-fix some issues."
                  else
                      echo "âœ… ESLint check passed with no issues"
                  fi

            - name: ðŸŽ¨ Prettier Check
              run: npm run format:check

            - name: ðŸ“ Naming Convention Check
              run: npm run validate-naming

    # ========================================================================
    # JOB 3: TypeScript & Type Validation
    # Purpose: Comprehensive type checking
    # Duration: ~30-60 seconds
    # ========================================================================
    type-checking:
        name: ðŸ” TypeScript & Types
        runs-on: ubuntu-latest
        needs: [setup, quick-checks]

        defaults:
            run:
                working-directory: ${{ env.WORKING_DIR }}

        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: ðŸ’¾ Restore node_modules cache
              uses: actions/cache@v4
              with:
                  path: ${{ env.WORKING_DIR }}/node_modules
                  key: ${{ runner.os }}-node-modules-${{ hashFiles('frontend/eetmad/package-lock.json') }}

            - name: ðŸ” TypeScript Check
              run: npm run type-check

            - name: ðŸ—ï¸ Type Validation
              run: npm run validate-types

    # ========================================================================
    # JOB 4: Design Rules Validation
    # Purpose: Validate design system compliance
    # Duration: ~20-40 seconds (only changed files in PRs)
    # ========================================================================
    design-validation:
        name: âœ… Design Rules
        runs-on: ubuntu-latest
        needs: [setup, quick-checks]

        defaults:
            run:
                working-directory: ${{ env.WORKING_DIR }}

        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: ðŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: ðŸ’¾ Restore node_modules cache
              uses: actions/cache@v4
              with:
                  path: ${{ env.WORKING_DIR }}/node_modules
                  key: ${{ runner.os }}-node-modules-${{ hashFiles('frontend/eetmad/package-lock.json') }}

            # For PRs: validate only changed files
            - name: ðŸ” Get Changed Files (PR)
              if: github.event_name == 'pull_request'
              id: changed-files-pr
              run: |
                  CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.(tsx?|ts)$' || echo "")
                  echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
                  echo "count=$(echo "$CHANGED_FILES" | grep -c . || echo 0)" >> $GITHUB_OUTPUT

            - name: âœ… Validate Changed Files (PR)
              if: github.event_name == 'pull_request' && steps.changed-files-pr.outputs.count != '0'
              run: |
                  FILES="${{ steps.changed-files-pr.outputs.files }}"
                  npm run validate:design $FILES

            # For pushes: validate all src/
            - name: âœ… Validate All Files (Push)
              if: github.event_name == 'push'
              run: npm run validate:design src/

            - name: ðŸ“Š Generate Validation Report
              if: always()
              run: |
                  npm run validate:design src/ --json validation-report.json || true

            - name: ðŸ“¤ Upload Validation Report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: validation-report
                  path: ${{ env.WORKING_DIR }}/validation-report.json
                  retention-days: 30

    # ========================================================================
    # JOB 5: Tests with Coverage
    # Purpose: Run test suite and generate coverage
    # Duration: ~1-3 minutes
    # ========================================================================
    test:
        name: ðŸ§ª Tests & Coverage
        runs-on: ubuntu-latest
        needs: [setup, quick-checks]

        defaults:
            run:
                working-directory: ${{ env.WORKING_DIR }}

        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Needed for --onlyChanged

            - name: ðŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: ðŸ’¾ Restore node_modules cache
              uses: actions/cache@v4
              with:
                  path: ${{ env.WORKING_DIR }}/node_modules
                  key: ${{ runner.os }}-node-modules-${{ hashFiles('frontend/eetmad/package-lock.json') }}

            # For PRs: run only affected tests
            - name: ðŸ§ª Run Affected Tests (PR)
              if: github.event_name == 'pull_request'
              run: npm run test -- --onlyChanged --coverage --passWithNoTests

            # For pushes: run all tests
            - name: ðŸ§ª Run All Tests (Push)
              if: github.event_name == 'push'
              run: npm run test -- --coverage

            - name: ðŸ“Š Upload Coverage Report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: ${{ env.WORKING_DIR }}/coverage/
                  retention-days: 30

            - name: ðŸ“ˆ Coverage Summary
              if: always()
              run: |
                  echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
                  if [ -f coverage/coverage-summary.json ]; then
                    cat coverage/coverage-summary.json >> $GITHUB_STEP_SUMMARY
                  fi

    # ========================================================================
    # JOB 6: Build
    # Purpose: Verify production build works
    # Duration: ~1-2 minutes
    # ========================================================================
    build:
        name: ðŸ—ï¸ Production Build
        runs-on: ubuntu-latest
        needs: [type-checking, design-validation, test]

        defaults:
            run:
                working-directory: ${{ env.WORKING_DIR }}

        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: ðŸ’¾ Restore node_modules cache
              uses: actions/cache@v4
              with:
                  path: ${{ env.WORKING_DIR }}/node_modules
                  key: ${{ runner.os }}-node-modules-${{ hashFiles('frontend/eetmad/package-lock.json') }}

            - name: ðŸ—ï¸ Build Application
              run: npm run build
              env:
                  NODE_ENV: production

            - name: ðŸ“Š Build Size Analysis
              run: |
                  echo "## ðŸ“¦ Build Size Report" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Total build size:**" >> $GITHUB_STEP_SUMMARY
                  du -sh .next >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "**Static assets:**" >> $GITHUB_STEP_SUMMARY
                  du -sh .next/static >> $GITHUB_STEP_SUMMARY || echo "No static assets" >> $GITHUB_STEP_SUMMARY

            - name: ðŸ“¤ Upload Build Artifacts
              uses: actions/upload-artifact@v4
              with:
                  name: build-output
                  path: ${{ env.WORKING_DIR }}/.next/
                  retention-days: 7

    # ========================================================================
    # JOB 7: Security Audit
    # Purpose: Check for security vulnerabilities
    # Duration: ~20-30 seconds
    # ========================================================================
    security:
        name: ðŸ”’ Security Audit
        runs-on: ubuntu-latest
        needs: setup

        defaults:
            run:
                working-directory: ${{ env.WORKING_DIR }}

        steps:
            - name: ðŸ“¥ Checkout code
              uses: actions/checkout@v4

            - name: ðŸ“¦ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: ${{ env.NODE_VERSION }}

            - name: ðŸ’¾ Restore node_modules cache
              uses: actions/cache@v4
              with:
                  path: ${{ env.WORKING_DIR }}/node_modules
                  key: ${{ runner.os }}-node-modules-${{ hashFiles('frontend/eetmad/package-lock.json') }}

            - name: ðŸ”’ NPM Audit (Production)
              run: npm audit --production --audit-level=high
              continue-on-error: true

            - name: ðŸ”’ NPM Audit (All)
              run: npm audit --audit-level=moderate
              continue-on-error: true

            - name: ðŸ” Check Circular Dependencies
              run: |
                  npm install -g madge
                  madge --circular --extensions ts,tsx src/ || echo "âš ï¸ Circular dependencies detected"

            - name: ðŸ“Š Security Summary
              if: always()
              run: |
                  echo "## ðŸ”’ Security Audit Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "âœ… Security checks completed" >> $GITHUB_STEP_SUMMARY
                  echo "Check logs above for details" >> $GITHUB_STEP_SUMMARY

    # ========================================================================
    # JOB 8: Final Summary
    # Purpose: Aggregate results and provide clear status
    # Duration: ~5 seconds
    # ========================================================================
    summary:
        name: ðŸ“Š Pipeline Summary
        runs-on: ubuntu-latest
        needs: [quick-checks, type-checking, design-validation, test, build, security]
        if: always()

        steps:
            - name: ðŸ“Š Generate Summary Report
              run: |
                  echo "# ðŸŽ¯ CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "## ðŸ“‹ Job Results" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
                  echo "| âš¡ Quick Checks | ${{ needs.quick-checks.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| ðŸ” Type Checking | ${{ needs.type-checking.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| âœ… Design Validation | ${{ needs.design-validation.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| ðŸ§ª Tests | ${{ needs.test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| ðŸ—ï¸ Build | ${{ needs.build.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "| ðŸ”’ Security | ${{ needs.security.result == 'success' && 'âœ… Passed' || 'âš ï¸ Warning' }} |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

            - name: âœ… All Checks Passed
              if: needs.quick-checks.result == 'success' && needs.type-checking.result == 'success' && needs.design-validation.result == 'success' && needs.test.result == 'success' && needs.build.result == 'success'
              run: |
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "## ðŸŽ‰ Success!" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "âœ… All validation checks passed successfully!" >> $GITHUB_STEP_SUMMARY
                  echo "Ready to merge to develop branch." >> $GITHUB_STEP_SUMMARY

            - name: âŒ Some Checks Failed
              if: needs.quick-checks.result != 'success' || needs.type-checking.result != 'success' || needs.design-validation.result != 'success' || needs.test.result != 'success' || needs.build.result != 'success'
              run: |
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "## âŒ Validation Failed" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "Some checks failed. Please review the errors above and fix them." >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### ðŸ”§ Quick Help" >> $GITHUB_STEP_SUMMARY
                  echo "- Run \`npm run check:health\` locally" >> $GITHUB_STEP_SUMMARY
                  echo "- Check specific failed jobs above" >> $GITHUB_STEP_SUMMARY
                  echo "- Review \`scripts/quick-reference/common-fixes.md\`" >> $GITHUB_STEP_SUMMARY
                  exit 1
