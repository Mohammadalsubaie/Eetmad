name: Develop Branch CI/CD

on:
    pull_request:
        branches:
            - develop
    push:
        branches:
            - develop

jobs:
    # Job 1: Code Quality Checks
    code-quality:
        name: Code Quality & Validation
        runs-on: ubuntu-latest

        defaults:
            run:
                working-directory: frontend/eetmad

        steps:
            - name: üì• Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0 # Full history for better diffs

            - name: üì¶ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'
                  cache-dependency-path: frontend/eetmad/package-lock.json

            - name: üì• Install dependencies
              run: npm ci

            - name: üîç TypeScript Check
              run: npm run type-check

            - name: üîç ESLint Check
              run: npm run lint:check

            - name: üîç Prettier Check
              run: npm run format:check

            - name: ‚úÖ Design Rules Validation
              run: npm run validate:design src/
              continue-on-error: false

            - name: üèóÔ∏è Type Validation
              run: npm run validate-types

            - name: üìù Naming Convention Check
              run: npm run validate-naming

            - name: üìä Generate Validation Report
              if: always()
              run: |
                  npm run validate:design src/ --json validation-report.json || true
                  echo "## Validation Report" >> $GITHUB_STEP_SUMMARY
                  if [ -f validation-report.json ]; then
                    echo "‚úÖ Report generated successfully" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "‚ö†Ô∏è No validation report generated" >> $GITHUB_STEP_SUMMARY
                  fi

            - name: üì§ Upload Validation Report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: validation-report
                  path: frontend/eetmad/validation-report.json
                  retention-days: 30

    # Job 2: Testing
    test:
        name: Run Tests
        runs-on: ubuntu-latest

        defaults:
            run:
                working-directory: frontend/eetmad

        steps:
            - name: üì• Checkout code
              uses: actions/checkout@v4

            - name: üì¶ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'
                  cache-dependency-path: frontend/eetmad/package-lock.json

            - name: üì• Install dependencies
              run: npm ci

            - name: üß™ Run Tests
              run: npm run test -- --coverage

            - name: üìä Upload Coverage Report
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: coverage-report
                  path: frontend/eetmad/coverage/
                  retention-days: 30

    # Job 3: Build Check
    build:
        name: Build Check
        runs-on: ubuntu-latest

        defaults:
            run:
                working-directory: frontend/eetmad

        steps:
            - name: üì• Checkout code
              uses: actions/checkout@v4

            - name: üì¶ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'
                  cache-dependency-path: frontend/eetmad/package-lock.json

            - name: üì• Install dependencies
              run: npm ci

            - name: üèóÔ∏è Build Application
              run: npm run build
              env:
                  NODE_ENV: production

            - name: üìä Check Build Size
              run: |
                  echo "## Build Size Report" >> $GITHUB_STEP_SUMMARY
                  du -sh .next >> $GITHUB_STEP_SUMMARY
                  echo "Build completed successfully ‚úÖ" >> $GITHUB_STEP_SUMMARY

    # Job 4: Security Audit
    security:
        name: Security Audit
        runs-on: ubuntu-latest

        defaults:
            run:
                working-directory: frontend/eetmad

        steps:
            - name: üì• Checkout code
              uses: actions/checkout@v4

            - name: üì¶ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'

            - name: üîí Run npm audit
              run: npm audit --audit-level=moderate
              continue-on-error: true

            - name: üîç Check for circular dependencies
              run: |
                  npm install -g madge
                  madge --circular --extensions ts,tsx src/ || echo "‚ö†Ô∏è Circular dependencies found"

    # Job 5: Changed Files Validation (for PRs)
    changed-files:
        name: Validate Changed Files
        runs-on: ubuntu-latest
        if: github.event_name == 'pull_request'

        defaults:
            run:
                working-directory: frontend/eetmad

        steps:
            - name: üì• Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: üì¶ Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: '20'
                  cache: 'npm'
                  cache-dependency-path: frontend/eetmad/package-lock.json

            - name: üì• Install dependencies
              run: npm ci

            - name: üîç Get Changed Files
              id: changed-files
              run: |
                  # Get changed TypeScript/TSX files
                  CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} ${{ github.sha }} | grep -E '\.(tsx?|ts)$' || echo "")
                  echo "changed_files=$CHANGED_FILES" >> $GITHUB_OUTPUT
                  echo "Changed files: $CHANGED_FILES"

            - name: ‚úÖ Validate Changed Files
              if: steps.changed-files.outputs.changed_files != ''
              run: |
                  FILES="${{ steps.changed-files.outputs.changed_files }}"
                  if [ ! -z "$FILES" ]; then
                    echo "Validating changed files..."
                    npm run validate:design $FILES
                  else
                    echo "No TypeScript/TSX files changed"
                  fi

    # Job 6: Summary Report
    summary:
        name: Summary Report
        runs-on: ubuntu-latest
        needs: [code-quality, test, build, security]
        if: always()

        steps:
            - name: üìä Generate Summary
              run: |
                  echo "# CI/CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "## Results" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "- Code Quality: ${{ needs.code-quality.result }}" >> $GITHUB_STEP_SUMMARY
                  echo "- Tests: ${{ needs.test.result }}" >> $GITHUB_STEP_SUMMARY
                  echo "- Build: ${{ needs.build.result }}" >> $GITHUB_STEP_SUMMARY
                  echo "- Security: ${{ needs.security.result }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  if [ "${{ needs.code-quality.result }}" == "success" ] && \
                     [ "${{ needs.test.result }}" == "success" ] && \
                     [ "${{ needs.build.result }}" == "success" ]; then
                    echo "‚úÖ All checks passed! Ready to merge." >> $GITHUB_STEP_SUMMARY
                  else
                    echo "‚ùå Some checks failed. Please review and fix." >> $GITHUB_STEP_SUMMARY
                  fi

            - name: ‚úÖ All Checks Passed
              if: needs.code-quality.result == 'success' && needs.test.result == 'success' && needs.build.result == 'success'
              run: echo "All checks passed successfully!"

            - name: ‚ùå Some Checks Failed
              if: needs.code-quality.result != 'success' || needs.test.result != 'success' || needs.build.result != 'success'
              run: |
                  echo "Some checks failed. Please review the logs above."
                  exit 1
