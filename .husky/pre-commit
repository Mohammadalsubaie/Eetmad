#!/usr/bin/env sh

# ============================================================================
# PRE-COMMIT HOOK - Fast validation for staged files only
# Execution time: ~5-15 seconds
# ============================================================================

echo ""
echo "ğŸ” Running pre-commit validation..."
echo ""

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Navigate to frontend/eetmad directory
cd frontend/eetmad || {
  echo "${RED}âŒ Error: Could not navigate to frontend/eetmad${NC}"
  exit 1
}

# Get staged .ts and .tsx files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E 'frontend/eetmad/.*\.(tsx?|ts)$' || echo "")

# Strip the 'frontend/eetmad/' prefix from file paths
STAGED_FILES=$(echo "$STAGED_FILES" | sed 's|^frontend/eetmad/||g')

if [ -z "$STAGED_FILES" ]; then
  echo "${YELLOW}âš ï¸  No TypeScript/TSX files staged - skipping validation${NC}"
  echo ""
  exit 0
fi

# Convert to space-separated list for commands
STAGED_FILES_LIST=$(echo "$STAGED_FILES" | tr '\n' ' ')

echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "${BLUE}ğŸ“‹ Validating Staged Files (Fast Checks)${NC}"
echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""
echo "${BLUE}Files to validate:${NC}"
echo "$STAGED_FILES" | sed 's/^/  âœ“ /'
echo ""

# Track overall success
CHECKS_PASSED=true

# ============================================================================
# CHECK 1: Prettier Format Check (~1-2 seconds)
# ============================================================================
echo "${BLUE}ğŸ¨ [1/3] Checking code formatting...${NC}"

if npx prettier --check $STAGED_FILES_LIST 2>/dev/null; then
  echo "${GREEN}âœ… Format check passed${NC}"
else
  echo "${RED}âŒ Format check failed${NC}"
  echo "${YELLOW}ğŸ’¡ Fix: npm run format${NC}"
  CHECKS_PASSED=false
fi
echo ""

# ============================================================================
# CHECK 2: ESLint (~2-5 seconds)
# ============================================================================
echo "${BLUE}ğŸ” [2/3] Running ESLint...${NC}"

if npx eslint --max-warnings=0 $STAGED_FILES_LIST 2>/dev/null; then
  echo "${GREEN}âœ… ESLint passed${NC}"
else
  echo "${RED}âŒ ESLint failed${NC}"
  echo "${YELLOW}ğŸ’¡ Fix: npm run lint -- --fix${NC}"
  CHECKS_PASSED=false
fi
echo ""

# ============================================================================
# CHECK 3: Design Rules Validation (~3-7 seconds)
# ============================================================================
echo "${BLUE}âœ… [3/3] Validating design rules...${NC}"

if npm run validate:design $STAGED_FILES_LIST 2>/dev/null; then
  echo "${GREEN}âœ… Design rules validation passed${NC}"
else
  echo "${RED}âŒ Design rules validation failed${NC}"
  echo "${YELLOW}ğŸ’¡ Check: scripts/quick-reference/common-fixes.md${NC}"
  CHECKS_PASSED=false
fi
echo ""

echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# ============================================================================
# FINAL RESULT
# ============================================================================
if [ "$CHECKS_PASSED" = true ]; then
  echo "${GREEN}âœ… All pre-commit checks passed! (Ready to commit)${NC}"
  echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  exit 0
else
  echo "${RED}âŒ Pre-commit validation failed!${NC}"
  echo ""
  echo "${YELLOW}ğŸ”§ Quick fixes:${NC}"
  echo "  1. Format code:     ${BLUE}npm run format${NC}"
  echo "  2. Fix ESLint:      ${BLUE}npm run lint -- --fix${NC}"
  echo "  3. Check errors:    ${BLUE}Review messages above${NC}"
  echo "  4. Interactive help: ${BLUE}npm run scripts:menu${NC}"
  echo ""
  echo "${YELLOW}âš ï¸  To bypass (NOT recommended):${NC}"
  echo "  ${BLUE}git commit --no-verify${NC}"
  echo ""
  echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  exit 1
fi