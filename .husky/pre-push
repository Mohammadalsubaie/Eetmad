#!/usr/bin/env sh

# ============================================================================
# PRE-PUSH HOOK - Comprehensive validation before pushing
# Execution time: ~1-3 minutes (optimized for changed files)
# ============================================================================

echo ""
echo "ğŸš€ Running pre-push validation..."
echo ""

# Navigate to frontend/eetmad directory
cd frontend/eetmad || {
  echo "âŒ Error: Could not navigate to frontend/eetmad"
  exit 1
}

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Track overall success
CHECKS_PASSED=true
START_TIME=$(date +%s)

echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "${BLUE}ğŸ“‹ Pre-Push Validation Checks${NC}"
echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Get list of changed files compared to remote
CHANGED_FILES=$(git diff --name-only @{u}..HEAD 2>/dev/null | grep -E 'frontend/eetmad/.*\.(tsx?|ts)$' | sed 's|^frontend/eetmad/||g' || echo "")
CHANGED_FILES_LIST=$(echo "$CHANGED_FILES" | tr '\n' ' ')

if [ -z "$CHANGED_FILES" ]; then
  echo "${CYAN}â„¹ï¸  No TypeScript/TSX files changed since last push${NC}"
  CHANGED_FILES_COUNT=0
else
  CHANGED_FILES_COUNT=$(echo "$CHANGED_FILES" | wc -l | tr -d ' ')
  echo "${CYAN}ğŸ“ Changed files: ${CHANGED_FILES_COUNT}${NC}"
  echo "$CHANGED_FILES" | head -5 | sed 's/^/  â€¢ /'
  if [ "$CHANGED_FILES_COUNT" -gt 5 ]; then
    echo "  ... and $((CHANGED_FILES_COUNT - 5)) more"
  fi
fi
echo ""

# ============================================================================
# CHECK 1: TypeScript Type Check
# ============================================================================
echo "${BLUE}ğŸ” [1/6] TypeScript type checking...${NC}"

if npm run type-check > /dev/null 2>&1; then
  echo "${GREEN}âœ… TypeScript check passed${NC}"
else
  echo "${RED}âŒ TypeScript check failed${NC}"
  echo "${YELLOW}ğŸ’¡ Run: npm run type-check (for details)${NC}"
  CHECKS_PASSED=false
fi
echo ""

# ============================================================================
# CHECK 2: ESLint
# ============================================================================
echo "${BLUE}ğŸ” [2/6] Running ESLint...${NC}"

if npm run lint:check > /dev/null 2>&1; then
  echo "${GREEN}âœ… ESLint check passed${NC}"
else
  echo "${RED}âŒ ESLint check failed${NC}"
  echo "${YELLOW}ğŸ’¡ Run: npm run lint -- --fix${NC}"
  CHECKS_PASSED=false
fi
echo ""

# ============================================================================
# CHECK 3: Prettier Format Check
# ============================================================================
echo "${BLUE}ğŸ¨ [3/6] Checking code formatting...${NC}"

if npm run format:check > /dev/null 2>&1; then
  echo "${GREEN}âœ… Format check passed${NC}"
else
  echo "${RED}âŒ Format check failed${NC}"
  echo "${YELLOW}ğŸ’¡ Run: npm run format${NC}"
  CHECKS_PASSED=false
fi
echo ""

# ============================================================================
# CHECK 4: Design Rules Validation (Changed files only)
# ============================================================================
echo "${BLUE}âœ… [4/6] Validating design rules...${NC}"

if [ -z "$CHANGED_FILES" ]; then
  echo "${CYAN}â­ï¸  No files to validate${NC}"
else
  if npm run validate:design $CHANGED_FILES_LIST > /dev/null 2>&1; then
    echo "${GREEN}âœ… Design rules validation passed${NC}"
  else
    echo "${RED}âŒ Design rules validation failed${NC}"
    echo "${YELLOW}ğŸ’¡ Check: scripts/quick-reference/common-fixes.md${NC}"
    CHECKS_PASSED=false
  fi
fi
echo ""

# ============================================================================
# CHECK 5: Tests (Only changed/affected tests)
# ============================================================================
echo "${BLUE}ğŸ§ª [5/6] Running tests...${NC}"

# Run only tests related to changed files for speed
if npm run test -- --onlyChanged --passWithNoTests --silent > /dev/null 2>&1; then
  echo "${GREEN}âœ… Tests passed${NC}"
else
  echo "${RED}âŒ Tests failed${NC}"
  echo "${YELLOW}ğŸ’¡ Run: npm run test (for details)${NC}"
  CHECKS_PASSED=false
fi
echo ""

# ============================================================================
# CHECK 6: Type Validation
# ============================================================================
echo "${BLUE}ğŸ—ï¸ [6/6] Validating types...${NC}"

if npm run validate-types > /dev/null 2>&1; then
  echo "${GREEN}âœ… Type validation passed${NC}"
else
  echo "${RED}âŒ Type validation failed${NC}"
  CHECKS_PASSED=false
fi
echo ""

# ============================================================================
# PERFORMANCE METRICS
# ============================================================================
END_TIME=$(date +%s)
DURATION=$((END_TIME - START_TIME))

echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "${CYAN}â±ï¸  Validation completed in ${DURATION}s${NC}"
echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# ============================================================================
# FINAL RESULT
# ============================================================================
if [ "$CHECKS_PASSED" = true ]; then
  echo "${GREEN}âœ… All pre-push checks passed! ğŸ‰${NC}"
  echo "${GREEN}   Ready to push to remote repository${NC}"
  echo ""
  echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  exit 0
else
  echo "${RED}âŒ Pre-push validation failed!${NC}"
  echo ""
  echo "${YELLOW}ğŸ”§ Recommended actions:${NC}"
  echo "  1. Run full health check: ${BLUE}npm run check:health${NC}"
  echo "  2. Interactive menu:       ${BLUE}npm run scripts:menu${NC}"
  echo "  3. Common fixes:           ${BLUE}cat scripts/quick-reference/common-fixes.md${NC}"
  echo ""
  echo "${YELLOW}ğŸ“Š Quick diagnosis:${NC}"
  echo "  â€¢ Type errors?    ${BLUE}npm run type-check${NC}"
  echo "  â€¢ Lint errors?    ${BLUE}npm run lint${NC}"
  echo "  â€¢ Test failures?  ${BLUE}npm run test${NC}"
  echo "  â€¢ Format issues?  ${BLUE}npm run format${NC}"
  echo ""
  echo "${YELLOW}âš ï¸  To skip validation (NOT recommended):${NC}"
  echo "  ${BLUE}git push --no-verify${NC}"
  echo ""
  echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  exit 1
fi