#!/usr/bin/env sh

echo ""
echo "ğŸš€ Running pre-push validation..."
echo ""

# Navigate to frontend/eetmad directory
cd frontend/eetmad || exit 1

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Track overall success
CHECKS_PASSED=true

echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo "${BLUE}ğŸ“‹ Running Pre-Push Validation Checks${NC}"
echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# 1. TypeScript Check
echo "${BLUE}ğŸ” [1/6] Checking TypeScript...${NC}"
if npm run type-check > /dev/null 2>&1; then
  echo "${GREEN}âœ… TypeScript check passed${NC}"
else
  echo "${RED}âŒ TypeScript check failed${NC}"
  CHECKS_PASSED=false
fi
echo ""

# 2. ESLint Check
echo "${BLUE}ğŸ” [2/6] Running ESLint...${NC}"
if npm run lint:check > /dev/null 2>&1; then
  echo "${GREEN}âœ… ESLint check passed${NC}"
else
  echo "${RED}âŒ ESLint check failed${NC}"
  echo "${YELLOW}ğŸ’¡ Run: npm run lint -- --fix${NC}"
  CHECKS_PASSED=false
fi
echo ""

# 3. Prettier Check
echo "${BLUE}ğŸ” [3/6] Checking code formatting...${NC}"
if npm run format:check > /dev/null 2>&1; then
  echo "${GREEN}âœ… Format check passed${NC}"
else
  echo "${RED}âŒ Format check failed${NC}"
  echo "${YELLOW}ğŸ’¡ Run: npm run format${NC}"
  CHECKS_PASSED=false
fi
echo ""

# 4. Design Rules Validation (only changed files)
echo "${BLUE}ğŸ” [4/6] Validating design rules...${NC}"
# Get list of changed .ts and .tsx files (strip frontend/eetmad/ prefix)
CHANGED_FILES=$(git diff --name-only HEAD @{u} 2>/dev/null | grep -E 'frontend/eetmad/.*\.(tsx?|ts)$' | sed 's|^frontend/eetmad/||g' || echo "")

if [ -z "$CHANGED_FILES" ]; then
  echo "${YELLOW}âš ï¸  No TypeScript/TSX files changed${NC}"
else
  if npm run validate:design $CHANGED_FILES > /dev/null 2>&1; then
    echo "${GREEN}âœ… Design rules validation passed${NC}"
  else
    echo "${RED}âŒ Design rules validation failed${NC}"
    echo "${YELLOW}ğŸ’¡ Check: scripts/quick-reference/common-fixes.md${NC}"
    CHECKS_PASSED=false
  fi
fi
echo ""

# 5. Type Validation
echo "${BLUE}ğŸ” [5/6] Validating types...${NC}"
if npm run validate-types > /dev/null 2>&1; then
  echo "${GREEN}âœ… Type validation passed${NC}"
else
  echo "${RED}âŒ Type validation failed${NC}"
  CHECKS_PASSED=false
fi
echo ""

# 6. Tests
echo "${BLUE}ğŸ§ª [6/6] Running tests...${NC}"
if npm run test -- --passWithNoTests > /dev/null 2>&1; then
  echo "${GREEN}âœ… Tests passed${NC}"
else
  echo "${RED}âŒ Tests failed${NC}"
  CHECKS_PASSED=false
fi
echo ""

echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# Final result
if [ "$CHECKS_PASSED" = true ]; then
  echo "${GREEN}âœ… All pre-push checks passed! Pushing code...${NC}"
  echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  exit 0
else
  echo "${RED}âŒ Pre-push checks failed!${NC}"
  echo ""
  echo "${YELLOW}Fix the issues above before pushing.${NC}"
  echo ""
  echo "ğŸ’¡ Quick help:"
  echo "  â€¢ Full check: ${BLUE}npm run check:health${NC}"
  echo "  â€¢ Interactive menu: ${BLUE}npm run scripts:menu${NC}"
  echo "  â€¢ Common fixes: ${BLUE}cat scripts/quick-reference/common-fixes.md${NC}"
  echo ""
  echo "To skip these checks (not recommended):"
  echo "  ${BLUE}git push --no-verify${NC}"
  echo ""
  echo "${BLUE}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
  echo ""
  exit 1
fi

